"""
Proxy Manager - –º–∞—Å—Å–æ–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–∫—Å–∏ (–∫–∞–∫ –≤ Key Collector)
–ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω —Å ProxyStore –∏ –∞–∫–∫–∞—É–Ω—Ç–∞–º–∏
"""

from PySide6 import QtWidgets, QtCore
from PySide6.QtCore import QThread, Signal
import asyncio
import aiohttp
import time
from datetime import datetime
from typing import Optional, List, Dict

try:
    from aiohttp_socks import ProxyConnector  # pip install aiohttp-socks
except ImportError:
    ProxyConnector = None

from ..core import proxy_store
from ..services import accounts as account_service


def parse_proxy_line(line: str) -> Optional[Dict]:
    """
    –ü–∞—Ä—Å–∏—Ç —Å—Ç—Ä–æ–∫—É –ø—Ä–æ–∫—Å–∏ –≤ –ª—é–±–æ–º —Ñ–æ—Ä–º–∞—Ç–µ:
    - ip:port
    - user:pass@ip:port
    - ip:port@user:pass  (SemTool —Ñ–æ—Ä–º–∞—Ç)
    - http://user:pass@ip:port
    - socks5://user:pass@ip:port
    """
    s = line.strip()
    if not s:
        return None
    
    # –§–æ—Ä–º–∞—Ç SemTool: ip:port@user:pass
    if '@' in s and not s.startswith(('http://', 'https://', 'socks')):
        parts = s.split('@', 1)
        if len(parts) == 2 and ':' in parts[0] and ':' in parts[1]:
            server_part = parts[0]  # ip:port
            auth_part = parts[1]     # user:pass
            username, password = auth_part.split(':', 1)
            return {
                "server": f"http://{server_part}",
                "scheme": "http",
                "login": username,
                "password": password,
                "raw": s
            }
    
    # –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –ø—Ä–µ—Ñ–∏–∫—Å
    if "://" not in s:
        s = "http://" + s
    
    # –ü–∞—Ä—Å–∏–º URL —Ñ–æ—Ä–º–∞—Ç
    m = re.match(r"(?P<scheme>https?|socks5)://(?:(?P<u>[^:@]+):(?P<p>[^@]+)@)?(?P<h>[^:]+):(?P<port>\d+)", s, re.I)
    if not m:
        return None
    
    d = m.groupdict()
    return {
        "server": f"{d['scheme'].lower()}://{d['h']}:{d['port']}",
        "scheme": d["scheme"].lower(),
        "login": d.get("u") or "",
        "password": d.get("p") or "",
        "raw": line.strip()
    }


async def check_http_proxy(px: Dict, timeout: float = 5.0) -> tuple:
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ HTTP/HTTPS –ø—Ä–æ–∫—Å–∏"""
    t0 = time.perf_counter()
    timeout_obj = aiohttp.ClientTimeout(total=timeout)
    
    try:
        async with aiohttp.ClientSession(timeout=timeout_obj) as session:
            proxy_auth = None
            if px["login"]:
                proxy_auth = aiohttp.BasicAuth(px["login"], px["password"] or "")
            
            # httpbin –ø–æ http, ssl=False - –∏–∑–±–µ–≥–∞–µ–º ssl:default –Ω–∞ –∫—Ä–∏–≤—ã—Ö http-–ø—Ä–æ–∫—Å–∏
            async with session.get(
                "http://httpbin.org/ip",
                proxy=px["server"],
                proxy_auth=proxy_auth,
                ssl=False
            ) as response:
                await response.text()
        
        elapsed_ms = int((time.perf_counter() - t0) * 1000)
        return ("OK", elapsed_ms, "")
    
    except asyncio.TimeoutError:
        elapsed_ms = int((time.perf_counter() - t0) * 1000)
        return ("TIMEOUT", elapsed_ms, "–ü—Ä–µ–≤—ã—à–µ–Ω —Ç–∞–π–º–∞—É—Ç")
    
    except Exception as e:
        elapsed_ms = int((time.perf_counter() - t0) * 1000)
        return ("FAIL", elapsed_ms, str(e)[:120])


async def check_socks_proxy(px: Dict, timeout: float = 5.0) -> tuple:
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ SOCKS –ø—Ä–æ–∫—Å–∏"""
    if ProxyConnector is None:
        return ("ERR", None, "aiohttp_socks –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
    
    t0 = time.perf_counter()
    
    try:
        conn = ProxyConnector.from_url(
            px["server"],
            rdns=True,
            username=px["login"] or None,
            password=px["password"] or None
        )
        
        timeout_obj = aiohttp.ClientTimeout(total=timeout)
        async with aiohttp.ClientSession(connector=conn, timeout=timeout_obj) as session:
            async with session.get("http://httpbin.org/ip") as response:
                await response.text()
        
        elapsed_ms = int((time.perf_counter() - t0) * 1000)
        return ("OK", elapsed_ms, "")
    
    except asyncio.TimeoutError:
        elapsed_ms = int((time.perf_counter() - t0) * 1000)
        return ("TIMEOUT", elapsed_ms, "–ü—Ä–µ–≤—ã—à–µ–Ω —Ç–∞–π–º–∞—É—Ç")
    
    except Exception as e:
        elapsed_ms = int((time.perf_counter() - t0) * 1000)
        return ("FAIL", elapsed_ms, str(e)[:120])


async def check_one_proxy(px: Dict, timeout: float = 5.0) -> tuple:
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –æ–¥–∏–Ω –ø—Ä–æ–∫—Å–∏
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: (status, latency_ms, error_message)
    """
    try:
        if px["scheme"].startswith("socks"):
            return await check_socks_proxy(px, timeout)
        else:
            return await check_http_proxy(px, timeout)
    except Exception as e:
        return ("FAIL", None, str(e)[:120])


class ProxyCheckThread(QThread):
    """–ü–æ—Ç–æ–∫ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–∫—Å–∏ —á–µ—Ä–µ–∑ asyncio"""
    
    progress = Signal(int, str, int, str)  # row, status, latency, error
    finished = Signal()
    
    def __init__(self, proxies: List[Dict], timeout: float = 5.0):
        super().__init__()
        self.proxies = proxies
        self.timeout = timeout
        self._stop = False
    
    def stop(self):
        self._stop = True
    
    def run(self):
        """–ó–∞–ø—É—Å–∫–∞–µ—Ç asyncio event loop –≤ –ø–æ—Ç–æ–∫–µ"""
        loop = asyncio.new_event_loop()
        asyncio.set_event_loop(loop)
        try:
            loop.run_until_complete(self._check_all())
        finally:
            loop.close()
            self.finished.emit()
    
    async def _check_all(self):
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –≤—Å–µ –ø—Ä–æ–∫—Å–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ"""
        sem = asyncio.Semaphore(40)  # 40 –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫
        
        async def check_one(idx, px):
            if self._stop:
                return
            
            async with sem:
                status, latency, error = await check_one_proxy(px, self.timeout)
                self.progress.emit(idx, status, latency or 0, error)
        
        tasks = [check_one(i, px) for i, px in enumerate(self.proxies)]
        await asyncio.gather(*tasks, return_exceptions=True)


class ProxyManagerDialog(QtWidgets.QDialog):
    """–û–∫–Ω–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–∫—Å–∏ (–∫–∞–∫ –≤ Key Collector)"""
    
    COLUMNS = ["ID", "Proxy", "–¢–∏–ø", "–õ–æ–≥–∏–Ω", "–ü–∞—Ä–æ–ª—å", "–°—Ç–∞—Ç—É—Å", "–ü–∏–Ω–≥ (–º—Å)", "–û—à–∏–±–∫–∞", "–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ"]
    
    def __init__(self, parent=None):
        super().__init__(parent)
        self.setWindowTitle("üîå –ü—Ä–æ–∫—Å–∏-–º–µ–Ω–µ–¥–∂–µ—Ä")
        self.setModal(False)  # –í–ê–ñ–ù–û: –Ω–µ–º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ, –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
        self.resize(1100, 650)
        
        # –î–∞–Ω–Ω—ã–µ
        self._proxies: List[Dict] = []
        self._check_thread = None
        
        # –°–æ–∑–¥–∞–µ–º UI
        self._create_ui()
        
        # –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ–∫—Å–∏ –∏–∑ ProxyStore
        self._load_from_store()
        
    def _create_ui(self):
        """–°–æ–∑–¥–∞–µ—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å"""
        layout = QtWidgets.QVBoxLayout(self)
        
        # –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        buttons_layout = QtWidgets.QHBoxLayout()
        
        self.btn_paste = QtWidgets.QPushButton("üìã –í—Å—Ç–∞–≤–∏—Ç—å –∏–∑ –±—É—Ñ–µ—Ä–∞")
        self.btn_load_file = QtWidgets.QPushButton("üìÅ –ó–∞–≥—Ä—É–∑–∏—Ç—å .txt")
        self.btn_check_all = QtWidgets.QPushButton("‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ")
        self.btn_stop = QtWidgets.QPushButton("‚õî –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å")
        self.btn_apply = QtWidgets.QPushButton("üíæ –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∫ –∞–∫–∫–∞—É–Ω—Ç–∞–º")
        self.btn_export = QtWidgets.QPushButton("üì§ –≠–∫—Å–ø–æ—Ä—Ç OK")
        self.btn_clear = QtWidgets.QPushButton("üóë –û—á–∏—Å—Ç–∏—Ç—å")
        self.btn_close = QtWidgets.QPushButton("‚ùå –ó–∞–∫—Ä—ã—Ç—å")
        
        self.btn_stop.setEnabled(False)
        
        buttons_layout.addWidget(self.btn_paste)
        buttons_layout.addWidget(self.btn_load_file)
        buttons_layout.addWidget(self.btn_check_all)
        buttons_layout.addWidget(self.btn_stop)
        buttons_layout.addWidget(self.btn_apply)
        buttons_layout.addWidget(self.btn_export)
        buttons_layout.addWidget(self.btn_clear)
        buttons_layout.addStretch()
        buttons_layout.addWidget(self.btn_close)
        
        layout.addLayout(buttons_layout)
        
        # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏
        settings_layout = QtWidgets.QHBoxLayout()
        settings_layout.addWidget(QtWidgets.QLabel("–ü–æ—Ç–æ–∫–æ–≤:"))
        
        self.spin_threads = QtWidgets.QSpinBox()
        self.spin_threads.setRange(1, 100)
        self.spin_threads.setValue(40)
        settings_layout.addWidget(self.spin_threads)
        
        settings_layout.addWidget(QtWidgets.QLabel("–¢–∞–π–º–∞—É—Ç (—Å–µ–∫):"))
        
        self.spin_timeout = QtWidgets.QSpinBox()
        self.spin_timeout.setRange(1, 60)
        self.spin_timeout.setValue(5)
        settings_layout.addWidget(self.spin_timeout)
        
        settings_layout.addStretch()
        
        self.lbl_stats = QtWidgets.QLabel("–í—Å–µ–≥–æ: 0 | OK: 0 | FAIL: 0")
        settings_layout.addWidget(self.lbl_stats)
        
        layout.addLayout(settings_layout)
        
        # –¢–∞–±–ª–∏—Ü–∞ –ø—Ä–æ–∫—Å–∏
        self.table = QtWidgets.QTableWidget(0, len(self.COLUMNS))
        self.table.setHorizontalHeaderLabels(self.COLUMNS)
        self.table.setSelectionBehavior(QtWidgets.QAbstractItemView.SelectRows)
        self.table.setAlternatingRowColors(True)
        
        # –†–∞—Å—Ç—è–≥–∏–≤–∞–µ–º –∫–æ–ª–æ–Ω–∫–∏
        header = self.table.horizontalHeader()
        header.setStretchLastSection(True)
        for i in [0, 6]:  # Proxy –∏ –û—à–∏–±–∫–∞
            header.setSectionResizeMode(i, QtWidgets.QHeaderView.Stretch)
        
        layout.addWidget(self.table)
        
        # –ü–æ–¥–∫–ª—é—á–∞–µ–º —Å–∏–≥–Ω–∞–ª—ã
        self.btn_paste.clicked.connect(self._on_paste)
        self.btn_load_file.clicked.connect(self._on_load_file)
        self.btn_check_all.clicked.connect(self._on_check_all)
        self.btn_stop.clicked.connect(self._on_stop)
        self.btn_clear.clicked.connect(self._on_clear)
        self.btn_export.clicked.connect(self._on_export)
        self.btn_close.clicked.connect(self.close)
    
    def _append_proxy(self, px: Dict):
        """–î–æ–±–∞–≤–ª—è–µ—Ç –ø—Ä–æ–∫—Å–∏ –≤ —Ç–∞–±–ª–∏—Ü—É"""
        row = self.table.rowCount()
        self.table.insertRow(row)
        
        values = [
            px["raw"],
            px["scheme"].upper(),
            px["login"],
            "***" if px["password"] else "",
            "WAIT",
            "",
            "",
            ""
        ]
        
        for col, value in enumerate(values):
            item = QtWidgets.QTableWidgetItem(str(value))
            if col == 4:  # –°—Ç–∞—Ç—É—Å
                item.setTextAlignment(QtCore.Qt.AlignCenter)
            self.table.setItem(row, col, item)
        
        self._proxies.append(px)
        self._update_stats()
    
    def _on_paste(self):
        """–í—Å—Ç–∞–≤–∏—Ç—å –∏–∑ –±—É—Ñ–µ—Ä–∞ –æ–±–º–µ–Ω–∞"""
        text = QtWidgets.QApplication.clipboard().text()
        added = 0
        
        for line in text.splitlines():
            px = parse_proxy_line(line)
            if px:
                self._append_proxy(px)
                added += 1
        
        QtWidgets.QMessageBox.information(
            self,
            "–î–æ–±–∞–≤–ª–µ–Ω–æ",
            f"–î–æ–±–∞–≤–ª–µ–Ω–æ –ø—Ä–æ–∫—Å–∏: {added}"
        )
    
    def _on_load_file(self):
        """–ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ —Ñ–∞–π–ª–∞"""
        path, _ = QtWidgets.QFileDialog.getOpenFileName(
            self,
            "–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª —Å –ø—Ä–æ–∫—Å–∏",
            "",
            "Text Files (*.txt);;All Files (*.*)"
        )
        
        if not path:
            return
        
        added = 0
        try:
            with open(path, "r", encoding="utf-8", errors="ignore") as f:
                for line in f:
                    px = parse_proxy_line(line)
                    if px:
                        self._append_proxy(px)
                        added += 1
            
            QtWidgets.QMessageBox.information(
                self,
                "–ó–∞–≥—Ä—É–∂–µ–Ω–æ",
                f"–ó–∞–≥—Ä—É–∂–µ–Ω–æ –ø—Ä–æ–∫—Å–∏: {added}"
            )
        except Exception as e:
            QtWidgets.QMessageBox.critical(
                self,
                "–û—à–∏–±–∫–∞",
                f"–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª:\n{e}"
            )
    
    def _on_check_all(self):
        """–ó–∞–ø—É—Å—Ç–∏—Ç—å –º–∞—Å—Å–æ–≤—É—é –ø—Ä–æ–≤–µ—Ä–∫—É"""
        if not self._proxies:
            QtWidgets.QMessageBox.warning(
                self,
                "–ù–µ—Ç –ø—Ä–æ–∫—Å–∏",
                "–î–æ–±–∞–≤—å—Ç–µ –ø—Ä–æ–∫—Å–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏"
            )
            return
        
        self._stop_flag = False
        self.btn_check_all.setEnabled(False)
        self.btn_stop.setEnabled(True)
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –≤ asyncio
        asyncio.create_task(self._check_all_async())
    
    async def _check_all_async(self):
        """–ú–∞—Å—Å–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–∫—Å–∏"""
        concurrency = self.spin_threads.value()
        timeout_ms = self.spin_timeout.value() * 1000
        
        sem = asyncio.Semaphore(concurrency)
        
        async def check_one(idx: int, px: Dict):
            if self._stop_flag:
                return
            
            async with sem:
                status, latency, error = await check_one_proxy(px, timeout_ms)
                
                # –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É
                self.table.item(idx, 4).setText(status)
                
                if latency is not None:
                    self.table.item(idx, 5).setText(str(latency))
                
                self.table.item(idx, 6).setText(error)
                
                now = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
                self.table.item(idx, 7).setText(now)
                
                # –¶–≤–µ—Ç–æ–≤–æ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ
                color = QtCore.Qt.green if status == "OK" else QtCore.Qt.red
                for col in range(self.table.columnCount()):
                    self.table.item(idx, col).setBackground(color)
                
                self._update_stats()
        
        tasks = [check_one(i, px) for i, px in enumerate(self._proxies)]
        await asyncio.gather(*tasks, return_exceptions=True)
        
        self.btn_check_all.setEnabled(True)
        self.btn_stop.setEnabled(False)
    
    def _on_stop(self):
        """–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É"""
        self._stop_flag = True
        self.btn_check_all.setEnabled(True)
        self.btn_stop.setEnabled(False)
    
    def _on_clear(self):
        """–û—á–∏—Å—Ç–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É"""
        reply = QtWidgets.QMessageBox.question(
            self,
            "–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ",
            "–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –ø—Ä–æ–∫—Å–∏?",
            QtWidgets.QMessageBox.Yes | QtWidgets.QMessageBox.No
        )
        
        if reply == QtWidgets.QMessageBox.Yes:
            self.table.setRowCount(0)
            self._proxies.clear()
            self._update_stats()
    
    def _on_export(self):
        """–≠–∫—Å–ø–æ—Ä—Ç —Ä–∞–±–æ—á–∏—Ö –ø—Ä–æ–∫—Å–∏"""
        ok_proxies = []
        
        for row in range(self.table.rowCount()):
            status = self.table.item(row, 4).text()
            if status == "OK":
                proxy_raw = self.table.item(row, 0).text()
                ok_proxies.append(proxy_raw)
        
        if not ok_proxies:
            QtWidgets.QMessageBox.warning(
                self,
                "–ù–µ—Ç —Ä–∞–±–æ—á–∏—Ö –ø—Ä–æ–∫—Å–∏",
                "–°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–æ–∫—Å–∏"
            )
            return
        
        path, _ = QtWidgets.QFileDialog.getSaveFileName(
            self,
            "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–∞–±–æ—á–∏–µ –ø—Ä–æ–∫—Å–∏",
            "working_proxies.txt",
            "Text Files (*.txt)"
        )
        
        if path:
            try:
                with open(path, "w", encoding="utf-8") as f:
                    f.write("\n".join(ok_proxies))
                
                QtWidgets.QMessageBox.information(
                    self,
                    "–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ",
                    f"–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –ø—Ä–æ–∫—Å–∏: {len(ok_proxies)}"
                )
            except Exception as e:
                QtWidgets.QMessageBox.critical(
                    self,
                    "–û—à–∏–±–∫–∞",
                    f"–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å:\n{e}"
                )
    
    def _update_stats(self):
        """–û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É"""
        total = self.table.rowCount()
        ok = 0
        fail = 0
        
        for row in range(total):
            status = self.table.item(row, 4).text()
            if status == "OK":
                ok += 1
            elif status in ("FAIL", "TIMEOUT", "ERR"):
                fail += 1
        
        self.lbl_stats.setText(f"–í—Å–µ–≥–æ: {total} | OK: {ok} | FAIL: {fail}")
    
    def get_working_proxies(self) -> List[str]:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —Ä–∞–±–æ—á–∏—Ö –ø—Ä–æ–∫—Å–∏"""
        working = []
        
        for row in range(self.table.rowCount()):
            status = self.table.item(row, 4).text()
            if status == "OK":
                proxy_raw = self.table.item(row, 0).text()
                working.append(proxy_raw)
        
        return working
